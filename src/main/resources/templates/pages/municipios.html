<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SISEPE - Municípios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" href="/img/favicon.png" type="image/png">
</head>
<body>

<div id="menu-placeholder"></div>

<!-- Page Content -->
<div class="container my-4">
    <h2 class="mb-4">Consulta de Municípios</h2>

    <div class="accordion" id="municipioAccordion">

        <!-- 1. Buscar Município por Cód. TSE -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">1. Buscar
                    Município por Cód. TSE
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                 data-bs-parent="#municipioAccordion">
                <div class="accordion-body">
                    <form id="form-1">
                        <div class="input-group">
                            <label for="param-1"></label><input type="number" class="form-control"
                                                                placeholder="Digite o Código TSE do município"
                                                                id="param-1" required>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. Buscar Zonas de um Município -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">2. Buscar Zonas
                    de um Município
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                 data-bs-parent="#municipioAccordion">
                <div class="accordion-body">
                    <form id="form-2">
                        <div class="input-group">
                            <label for="param-2"></label><input type="text" class="form-control"
                                                                placeholder="Digite o nome do município"
                                                                id="param-2" required>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 3. Buscar Polo de um Município -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">3. Buscar
                    Polo de um Município
                </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                 data-bs-parent="#municipioAccordion">
                <div class="accordion-body">
                    <form id="form-3">
                        <div class="input-group">
                            <label for="param-3"></label><input type="text" class="form-control"
                                                                placeholder="Digite o nome do município"
                                                                id="param-3" required>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 4. Buscar Seções de um Município -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">4. Buscar
                    Seções de um Município
                </button>
            </h2>
            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour"
                 data-bs-parent="#municipioAccordion">
                <div class="accordion-body">
                    <form id="form-4">
                        <div class="input-group">
                            <label for="param-4"></label><input type="text" class="form-control"
                                                                placeholder="Digite o nome do município"
                                                                id="param-4" required>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" class="mt-4">
        <h4 class="mb-3">Resultado</h4>
        <div id="result-container"></div>
        <div id="pagination-wrapper" class="d-flex justify-content-center mt-4"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/loadMenuInterno.js?v=2"></script>
<script>
    const containerResultados = document.getElementById('result-container');
    const containerPaginacao = document.getElementById('pagination-wrapper');
    const API_BASE_URL = 'http://localhost:8080';

    let todosOsDados = [];
    let paginaAtual = 1;
    const linhasPorPagina = 10;
    let colunaOrdenacao = -1;
    let ordemOrdenacao = 'asc';

    function exibirTabela(dados, cabecalhos, renderizadorLinha, pagina) {
        paginaAtual = pagina;
        containerResultados.innerHTML = '';
        containerPaginacao.innerHTML = '';

        const tabela = document.createElement('table');
        tabela.className = 'table table-striped table-hover table-bordered';
        const cabecalhoTabela = document.createElement('thead');
        cabecalhoTabela.className = 'table-dark';
        const linhaCabecalho = document.createElement('tr');
        cabecalhos.forEach((textoCabecalho, index) => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.style.cursor = 'pointer';
            th.innerHTML = `${textoCabecalho} <span class="sort-arrow">${colunaOrdenacao === index ? (ordemOrdenacao === 'asc' ? '↓' : '↑') : '↓↑'}</span>`;
            if (colunaOrdenacao === index) {
                th.querySelector('.sort-arrow').style.color = 'white';
            }
            th.addEventListener('click', () => {
                if (colunaOrdenacao === index) {
                    ordemOrdenacao = ordemOrdenacao === 'asc' ? 'desc' : 'asc';
                } else {
                    colunaOrdenacao = index;
                    ordemOrdenacao = 'asc';
                }
                ordenarDados(index, ordemOrdenacao);
                exibirTabela(todosOsDados, cabecalhos, renderizadorLinha, 1);
            });
            linhaCabecalho.appendChild(th);
        });
        cabecalhoTabela.appendChild(linhaCabecalho);
        tabela.appendChild(cabecalhoTabela);

        const corpoTabela = document.createElement('tbody');
        const inicio = (pagina - 1) * linhasPorPagina;
        const fim = inicio + linhasPorPagina;
        const dadosPaginados = dados.slice(inicio, fim);

        dadosPaginados.forEach(item => {
            const linha = document.createElement('tr');
            linha.innerHTML = renderizadorLinha(item);
            corpoTabela.appendChild(linha);
        });
        tabela.appendChild(corpoTabela);
        containerResultados.appendChild(tabela);

        configurarPaginacao(dados.length, cabecalhos, renderizadorLinha);
    }

    function ordenarDados(indiceColuna, ordem) {
        todosOsDados.sort((a, b) => {
            const valorA = Object.values(a)[indiceColuna];
            const valorB = Object.values(b)[indiceColuna];

            if (valorA < valorB) {
                return ordem === 'asc' ? -1 : 1;
            }
            if (valorA > valorB) {
                return ordem === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }

    function configurarPaginacao(totalItens, cabecalhos, renderizadorLinha) {
        const totalPaginas = Math.ceil(totalItens / linhasPorPagina);
        if (totalPaginas <= 1) {
            containerPaginacao.innerHTML = '';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'pagination';

        // Botão para primeira página
        const primeiroLi = document.createElement('li');
        primeiroLi.className = `page-item ${paginaAtual === 1 ? 'disabled' : ''}`;
        const primeiroA = document.createElement('a');
        primeiroA.className = 'page-link';
        primeiroA.href = '#';
        primeiroA.innerHTML = '&laquo;';
        primeiroA.addEventListener('click', (event) => {
            event.preventDefault();
            if (paginaAtual > 1) {
                exibirTabela(todosOsDados, cabecalhos, renderizadorLinha, 1);
            }
        });
        primeiroLi.appendChild(primeiroA);
        ul.appendChild(primeiroLi);

        // Botões de número de página
        let paginaInicio = Math.max(1, paginaAtual - 2);
        let paginaFim = Math.min(totalPaginas, paginaAtual + 2);

        if (paginaAtual <= 3) {
            paginaFim = Math.min(5, totalPaginas);
        }
        if (paginaAtual > totalPaginas - 3) {
            paginaInicio = Math.max(1, totalPaginas - 4);
        }

        for (let i = paginaInicio; i <= paginaFim; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === paginaAtual ? 'active' : ''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (event) => {
                event.preventDefault();
                exibirTabela(todosOsDados, cabecalhos, renderizadorLinha, i);
            });
            li.appendChild(a);
            ul.appendChild(li);
        }

        // Botão para última página
        const ultimoLi = document.createElement('li');
        ultimoLi.className = `page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}`;
        const ultimoA = document.createElement('a');
        ultimoA.className = 'page-link';
        ultimoA.href = '#';
        ultimoA.innerHTML = '&raquo;';
        ultimoA.addEventListener('click', (event) => {
            event.preventDefault();
            if (paginaAtual < totalPaginas) {
                exibirTabela(todosOsDados, cabecalhos, renderizadorLinha, totalPaginas);
            }
        });
        ultimoLi.appendChild(ultimoA);
        ul.appendChild(ultimoLi);

        containerPaginacao.innerHTML = '';
        containerPaginacao.appendChild(ul);
    }

    function tratarEnvioDeFormulario(event, apiUrl, cabecalhos, renderizadorLinha) {
        event.preventDefault();
        containerResultados.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        containerPaginacao.innerHTML = '';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (!data || data.length === 0) {
                    containerResultados.innerHTML = '<div class="alert alert-warning" role="alert">Nenhum resultado encontrado.</div>';
                    return;
                }

                const tabela = document.createElement('table');
                tabela.className = 'table table-striped table-hover table-bordered';
                const cabecalhoTabela = document.createElement('thead');
                cabecalhoTabela.className = 'table-dark';
                const linhaCabecalho = document.createElement('tr');
                cabecalhos.forEach(textoCabecalho => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.textContent = textoCabecalho;
                    linhaCabecalho.appendChild(th);
                });
                cabecalhoTabela.appendChild(linhaCabecalho);
                tabela.appendChild(cabecalhoTabela);

                const corpoTabela = document.createElement('tbody');
                const dadosArray = Array.isArray(data) ? data : [data];
                dadosArray.forEach(item => {
                    const linha = document.createElement('tr');
                    linha.innerHTML = renderizadorLinha(item);
                    corpoTabela.appendChild(linha);
                });
                tabela.appendChild(corpoTabela);

                containerResultados.innerHTML = '';
                containerResultados.appendChild(tabela);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                containerResultados.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Erro ao buscar dados:</strong> ${error.message}.</div>`;
            });
    }

    function tratarEnvioDeFormularioComPaginacao(event, apiUrl, cabecalhos, renderizadorLinha) {
        event.preventDefault();
        containerResultados.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        containerPaginacao.innerHTML = '';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                todosOsDados = data;
                colunaOrdenacao = -1;
                ordemOrdenacao = 'asc';
                if (!todosOsDados || todosOsDados.length === 0) {
                    containerResultados.innerHTML = '<div class="alert alert-warning" role="alert">Nenhum resultado encontrado.</div>';
                    return;
                }
                exibirTabela(todosOsDados, cabecalhos, renderizadorLinha, 1);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                containerResultados.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Erro ao buscar dados:</strong> ${error.message}.</div>`;
            });
    }

    // 1. Buscar Município por Cód. TSE
    document.getElementById('form-1').addEventListener('submit', (event) => {
        const codTse = document.getElementById('param-1').value;
        tratarEnvioDeFormulario(event,
            `${API_BASE_URL}/municipios/codTse?codTse=${codTse}`,
            ['Cód. TSE', 'Nome', 'Polo'],
            (item) => `<td>${item.codTse}</td><td>${item.nome}</td><td>${item.numPolo}</td>`
        );
    });

    // 2. Buscar Zonas de um Município
    document.getElementById('form-2').addEventListener('submit', (event) => {
        const nomeMunicipio = document.getElementById('param-2').value;
        tratarEnvioDeFormulario(event,
            `${API_BASE_URL}/municipios/zonas?nomeMunicipio=${nomeMunicipio}`,
            ['Num. Zona', 'Código TSE', 'Município Sede', 'Num. Polo'],
            (item) => `<td>${item.numZona}</td><td>${item.municipioCodTse}</td><td>${item.nomeMunicipio}</td><td>${item.numPolo}</td>`
        );
    });

    // 3. Buscar Polo de um Município
    document.getElementById('form-3').addEventListener('submit', (event) => {
        const nomeMunicipio = document.getElementById('param-3').value;
        tratarEnvioDeFormularioComPaginacao(event,
            `${API_BASE_URL}/municipios/polos?nomeMunicipio=${nomeMunicipio}`,
            ['Cód. TSE', 'Nome', 'Polo'],
            (item) => `<td>${item.codTse}</td><td>${item.nome}</td><td>${item.numPolo}</td>`
        );
    });

    // 4. Buscar Seções de um Município
    document.getElementById('form-4').addEventListener('submit', (event) => {
        const nomeMunicipio = document.getElementById('param-4').value;
        tratarEnvioDeFormularioComPaginacao(event,
            `${API_BASE_URL}/municipios/secoes?nomeMunicipio=${nomeMunicipio}`,
            ['Número da seção'],
            (item) => `<td>${item.numSecao}</td>`
        );
    });
</script>

</body>
</html>